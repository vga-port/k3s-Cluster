---
- name: Ensure kubeconfig exists on master
  stat:
    path: "{{ rancher_kubeconfig_path }}"
  register: kubeconfig_check

- name: Fail if kubeconfig missing
  fail:
    msg: "k3s kubeconfig not found at {{ rancher_kubeconfig_path }}; ensure cluster_bootstrap ran successfully"
  when: not kubeconfig_check.stat.exists

- name: Wait for kubectl to respond
  command: kubectl --kubeconfig=/etc/rancher/k3s/k3s.yaml get --raw=/healthz
  register: apih
  retries: 30
  delay: 2
  until: apih.rc == 0 and (apih.stdout | trim) == "ok"
  changed_when: false

# ------------------------------
# cert-manager (required by Rancher)
# ------------------------------

- name: Add Jetstack repo
  kubernetes.core.helm_repository:
    name: jetstack
    repo_url: https://charts.jetstack.io

- name: Install/upgrade cert-manager
  kubernetes.core.helm:
    name: cert-manager
    chart_ref: jetstack/cert-manager
    chart_version: "v1.14.4"
    release_namespace: cert-manager
    create_namespace: true
    wait: true
    timeout: "10m0s"
    set_values:
      - value: installCRDs=true
    update_repo_cache: true
    kubeconfig: /etc/rancher/k3s/k3s.yaml
    binary_path: /usr/local/bin/helm

- name: Wait for cert-manager deployments to be available
  kubernetes.core.k8s_info:
    api_version: apps/v1
    kind: Deployment
    namespace: cert-manager
    name: "{{ item }}"
    kubeconfig: /etc/rancher/k3s/k3s.yaml
  loop:
    - cert-manager
    - cert-manager-webhook
    - cert-manager-cainjector
  register: cm_deploy
  retries: 60
  delay: 5
  until: >
    cm_deploy.resources | length > 0 and
    (cm_deploy.resources[0].status.availableReplicas | default(0)) | int >= 1

# ------------------------------
# Rancher install
# ------------------------------

- name: Add Rancher repo
  kubernetes.core.helm_repository:
    name: rancher-stable
    repo_url: https://releases.rancher.com/server-charts/stable
    binary_path: /usr/local/bin/helm

- name: Install Rancher
  kubernetes.core.helm:
    name: rancher
    chart_ref: rancher-stable/rancher
    chart_version: "2.8.5"            # <-- NOT "version:"
    release_namespace: cattle-system
    create_namespace: true
    values_files:
      - /etc/homelab-values/rancher.yaml
    kubeconfig: /etc/rancher/k3s/k3s.yaml
    binary_path: /usr/local/bin/helm
    wait: true
    timeout: "30m0s"                  # <-- Rancher often takes ages on homelabs
    update_repo_cache: true

- name: Ensure cattle-system namespace exists
  kubernetes.core.k8s:
    api_version: v1
    kind: Namespace
    name: cattle-system
    state: present
    kubeconfig: "{{ rancher_kubeconfig_path }}"

- name: Show Rancher access URL
  debug:
    msg: "Rancher should be available at https://{{ rancher_hostname }} once LoadBalancer/DNS is in place."
