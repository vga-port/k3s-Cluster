---
- name: Ensure kubeconfig exists
  stat:
    path: /etc/rancher/k3s/k3s.yaml
  register: kubeconfig_check

- name: Fail if kubeconfig missing
  fail:
    msg: "k3s kubeconfig not found"
  when: not kubeconfig_check.stat.exists

# ---- Longhorn values sync to remote ----

- name: Ensure values directory exists on remote (for Longhorn)
  file:
    path: /etc/homelab-values
    state: directory
    mode: '0755'
  when: storage_provider == "longhorn"

- name: Copy Longhorn values to remote
  copy:
    src: "{{ playbook_dir }}/values/longhorn.yaml"
    dest: /etc/homelab-values/longhorn.yaml
    mode: '0644'
  when: storage_provider == "longhorn"

# ---- Longhorn Helm install ----

- name: Add Longhorn repo
  kubernetes.core.helm_repository:
    name: longhorn
    repo_url: https://charts.longhorn.io
    binary_path: /usr/local/bin/helm
  when: storage_provider == "longhorn"

- name: Install Longhorn
  kubernetes.core.helm:
    release_name: longhorn
    chart_ref: longhorn/longhorn
    chart_version: "1.5.0"
    release_namespace: longhorn-system
    create_namespace: true
    values_files:
      - /etc/homelab-values/longhorn.yaml
    kubeconfig: /etc/rancher/k3s/k3s.yaml
    binary_path: /usr/local/bin/helm
    wait: true
    timeout: "30m0s"
    atomic: true
    update_repo_cache: true

# ---- Longhorn Check install ----

- name: Ensure longhorn-system namespace exists
  kubernetes.core.k8s_info:
    api_version: v1
    kind: Namespace
    name: longhorn-system
    kubeconfig: /etc/rancher/k3s/k3s.yaml
  register: lh_ns

- name: Fail fast if Longhorn namespace missing (Longhorn not installed)
  fail:
    msg: "longhorn-system namespace not found. Longhorn is not installed or installed elsewhere."
  when: lh_ns.resources | length == 0

- name: List Longhorn deployments
  kubernetes.core.k8s_info:
    api_version: apps/v1
    kind: Deployment
    namespace: longhorn-system
    kubeconfig: /etc/rancher/k3s/k3s.yaml
  register: lh_deploys

- name: Pick admission webhook deployment name (auto-detect)
  set_fact:
    lh_admission_webhook_deploy: >-
      {{
        (lh_deploys.resources
          | map(attribute='metadata.name')
          | select('search', 'admission-webhook')
          | list
          | first) | default('')
      }}

- name: Wait for Longhorn admission webhook service endpoints
  kubernetes.core.k8s_info:
    api_version: v1
    kind: Endpoints
    namespace: longhorn-system
    name: longhorn-admission-webhook
    kubeconfig: /etc/rancher/k3s/k3s.yaml
  register: lh_webhook_eps
  retries: 30
  delay: 5
  until: >
    lh_webhook_eps.resources | length > 0 and
    lh_webhook_eps.resources[0].subsets is defined and
    (lh_webhook_eps.resources[0].subsets | length) > 0

- name: Wait for Longhorn admission webhook deployment to be available
  kubernetes.core.k8s_info:
    api_version: apps/v1
    kind: Deployment
    namespace: longhorn-system
    name: "{{ lh_admission_webhook_deploy }}"
    kubeconfig: /etc/rancher/k3s/k3s.yaml
  register: lh_webhook_dep
  retries: 30
  delay: 5
  until: (lh_webhook_dep.resources[0].status.availableReplicas | default(0) | int) >= 1

- name: List Longhorn services
  kubernetes.core.k8s_info:
    api_version: v1
    kind: Service
    namespace: longhorn-system
    kubeconfig: /etc/rancher/k3s/k3s.yaml
  register: lh_svcs

- name: Pick admission webhook service name (auto-detect)
  set_fact:
    lh_admission_webhook_svc: >-
      {{
        (lh_svcs.resources
          | map(attribute='metadata.name')
          | select('search', 'admission-webhook')
          | list
          | first) | default('')
      }}

- name: Fail if admission webhook service not found
  fail:
    msg: "No admission-webhook service found in longhorn-system. Found services: {{ lh_svcs.resources | map(attribute='metadata.name') | list }}"
  when: lh_admission_webhook_svc == ''

- name: Wait for Longhorn admission webhook service to have endpoints
  kubernetes.core.k8s_info:
    api_version: v1
    kind: Endpoints
    namespace: longhorn-system
    name: longhorn-admission-webhook
    kubeconfig: /etc/rancher/k3s/k3s.yaml
  register: lh_webhook_eps
  retries: 30
  delay: 5
  until: >
    lh_webhook_eps.resources | length > 0 and
    lh_webhook_eps.resources[0].subsets is defined and
    (lh_webhook_eps.resources[0].subsets | length) > 0

- name: Wait for Longhorn manager daemonset to be ready
  kubernetes.core.k8s_info:
    api_version: apps/v1
    kind: DaemonSet
    namespace: longhorn-system
    name: longhorn-manager
    kubeconfig: /etc/rancher/k3s/k3s.yaml
  register: lh_mgr
  retries: 30
  delay: 5
  until: >
    lh_mgr.resources | length > 0 and
    (lh_mgr.resources[0].status.numberReady | default(0) | int) >= 1